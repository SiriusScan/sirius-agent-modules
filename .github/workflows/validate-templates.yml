name: Validate Templates

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'templates/**'
      - 'scripts/**'
      - '*.json'
  pull_request:
    branches: [ main ]
    paths:
      - 'templates/**'
      - 'scripts/**'
      - '*.json'

jobs:
  validate-templates:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22'
    
    - name: Install yq
      run: |
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod +x /usr/local/bin/yq
    
    - name: Validate JSON manifests
      run: |
        echo "Validating repository-manifest.json..."
        jq empty repository-manifest.json
        echo "Validating templates/manifest.json..."
        jq empty templates/manifest.json
        echo "Validating scripts/manifest.json..."
        jq empty scripts/manifest.json
    
    - name: Validate YAML templates
      run: |
        echo "Validating YAML syntax..."
        find templates/ -name "*.yaml" -exec yq eval . {} \; > /dev/null
        echo "All YAML files are valid"
    
    - name: Check template structure
      run: |
        echo "Checking template structure..."
        for template in templates/*/*.yaml; do
          echo "Validating $template..."
          # Check required fields
          id=$(yq eval '.id' "$template")
          if [ "$id" = "null" ]; then
            echo "ERROR: Missing 'id' field in $template"
            exit 1
          fi
          
          name=$(yq eval '.info.name' "$template")
          if [ "$name" = "null" ]; then
            echo "ERROR: Missing 'info.name' field in $template"
            exit 1
          fi
          
          severity=$(yq eval '.info.severity' "$template")
          if [ "$severity" = "null" ]; then
            echo "ERROR: Missing 'info.severity' field in $template"
            exit 1
          fi
          
          detection_type=$(yq eval '.detection.type' "$template")
          if [ "$detection_type" = "null" ]; then
            echo "ERROR: Missing 'detection.type' field in $template"
            exit 1
          fi
        done
        echo "All templates have required fields"
    
    - name: Validate checksums
      run: |
        echo "Validating checksums in manifest..."
        for template in templates/*/*.yaml; do
          relative_path=$(echo "$template" | sed 's|templates/||')
          manifest_checksum=$(jq -r ".templates.\"$relative_path\".checksum" templates/manifest.json)
          if [ "$manifest_checksum" != "null" ]; then
            actual_checksum=$(sha256sum "$template" | cut -d' ' -f1)
            if [ "$manifest_checksum" != "sha256:$actual_checksum" ]; then
              echo "ERROR: Checksum mismatch for $template"
              echo "Expected: $manifest_checksum"
              echo "Actual: sha256:$actual_checksum"
              exit 1
            fi
          fi
        done
        echo "All checksums are valid"
    
    - name: Security scan
      run: |
        echo "Running security scan..."
        # Check for dangerous patterns in templates
        for template in templates/*/*.yaml; do
          if grep -q "eval\|exec\|system\|shell" "$template"; then
            echo "WARNING: Potentially dangerous pattern found in $template"
          fi
        done
        echo "Security scan completed"
